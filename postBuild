#!/usr/bin/env bash
set -euo pipefail

# Streamlit Cloud images sometimes only have `python3` in PATH.
PY_BIN="python"
if ! command -v "${PY_BIN}" >/dev/null 2>&1; then
  PY_BIN="python3"
fi

# Some dependencies (e.g. `ultralytics`) may pull in `opencv-python` (GUI build) which can fail
# on Streamlit Cloud with `libGL.so.1` errors. Ensure the *last* installed OpenCV wheel is the
# headless one; a force reinstall is enough and avoids uv/pip uninstall prompts/permission issues.
"${PY_BIN}" -m pip install --no-cache-dir --upgrade --force-reinstall opencv-python-headless==4.11.0.86

echo "== OpenCV sanity check =="
"${PY_BIN}" - <<'PY'
import importlib
import importlib.metadata as md

for dist in [
    "opencv-python-headless",
    "opencv-python",
    "opencv-contrib-python",
    "opencv-contrib-python-headless",
]:
    try:
        print(f"{dist}=={md.version(dist)}")
    except md.PackageNotFoundError:
        print(f"{dist} (not installed)")

try:
    cv2 = importlib.import_module("cv2")
    print("cv2 import OK", getattr(cv2, "__version__", ""))
except Exception as e:
    raise SystemExit(f"cv2 import FAILED: {e!r}")
PY
